# 前端代码质量指南

本文档详细说明了前端仓库的代码要求、质量标准、检测方式以及最佳实践。所有开发者应遵循这些指南，以确保代码的一致性、可维护性和高质量。

## 目录

1. [代码质量要求](#代码质量要求)
2. [代码风格规范](#代码风格规范)
3. [代码检查工具](#代码检查工具)
4. [API调用规范](#API调用规范)
5. [组件开发规范](#组件开发规范)
6. [性能优化指南](#性能优化指南)
7. [常见问题与解决方案](#常见问题与解决方案)
8. [提交前检查清单](#提交前检查清单)

## 代码质量要求

### 1. 代码复杂度控制

- **认知复杂度限制**：函数的认知复杂度不应超过15（由SonarJS插件检测）
- **函数长度**：单个函数不应过长，建议不超过50行
- **组件拆分**：复杂组件应拆分为多个小型组件，每个组件职责单一
- **嵌套层级**：控制条件语句和循环的嵌套层级，不应超过3层

### 2. 类型安全

- **使用TypeScript**：所有代码应使用TypeScript编写，确保类型安全
- **避免any**：尽量避免使用`any`类型，应定义明确的接口和类型
- **类型导出**：公共类型应在`types`目录下定义并导出
- **类型检查**：提交前应通过TypeScript类型检查（`pnpm type-check`）

### 3. 错误处理

- **异步错误**：所有异步操作应有适当的错误处理
- **用户反馈**：错误应以用户友好的方式呈现，而不是直接显示技术错误
- **日志记录**：关键操作应有适当的日志记录，便于调试
- **优雅降级**：在功能不可用时应提供优雅的降级方案

### 4. 代码重用

- **避免重复**：避免代码重复，提取共用逻辑到独立函数或组件
- **使用钩子**：使用自定义钩子（Custom Hooks）组织相关状态和逻辑
- **组件抽象**：将通用UI模式抽象为可重用组件
- **工具函数**：将通用功能抽象为工具函数，放在`utils`目录下

## 代码风格规范

### 1. 格式化规则

- **使用Prettier**：所有代码应使用Prettier格式化，确保一致的代码风格
- **缩进**：使用2个空格缩进
- **行宽**：最大行宽为100个字符
- **引号**：使用双引号（`"`）而非单引号
- **分号**：语句末尾使用分号
- **尾随逗号**：对象和数组使用尾随逗号（ES5兼容）
- **括号间距**：对象字面量中的括号内部有空格
- **箭头函数参数**：箭头函数参数始终使用括号

### 2. 命名规范

- **组件命名**：使用PascalCase命名组件（如`UserProfile`）
- **文件命名**：组件文件使用PascalCase（如`UserProfile.tsx`），非组件文件使用camelCase（如`apiClient.ts`）
- **钩子命名**：自定义钩子以`use`前缀命名（如`useAuth`）
- **常量命名**：全局常量使用UPPER_SNAKE_CASE（如`API_BASE_URL`）
- **变量命名**：使用有意义的描述性名称，避免缩写
- **布尔值命名**：布尔值变量应使用`is`、`has`、`should`等前缀（如`isLoading`）
- **事件处理函数**：使用`handle`前缀（如`handleSubmit`）

### 3. 导入顺序

按以下顺序组织导入语句：
1. 类型导入
2. 内置模块
3. 外部库
4. 内部模块（以`@/`开头）
5. 父目录模块
6. 同级目录模块
7. 索引模块

导入组之间应有空行分隔。

### 4. 代码注释

- **文档注释**：公共API、组件和函数应有JSDoc风格的文档注释
- **复杂逻辑**：复杂逻辑应有注释说明
- **TODO注释**：使用`// TODO:`标记待完成的工作
- **废弃标记**：使用`@deprecated`标记废弃的API

## 代码检查工具

### 1. ESLint

- **配置文件**：`.eslintrc.json`
- **主要插件**：
  - `sonarjs`：检测代码中的潜在问题和复杂度
  - `react`：React特定规则
  - `react-hooks`：React Hooks规则
  - `jsx-a11y`：可访问性规则
  - `@typescript-eslint`：TypeScript特定规则
  - `import`：导入顺序规则
  - `unused-imports`：未使用导入检测
  - `prettier`：与Prettier集成

- **运行命令**：
  - `pnpm lint`：运行ESLint并自动修复问题
  - `pnpm lint:strict`：严格模式运行ESLint（不允许警告）
  - `pnpm check:eslint`：仅运行ESLint检查

### 2. Prettier

- **配置文件**：`.prettierrc`
- **主要配置**：
  - `semi: true`：使用分号
  - `singleQuote: false`：使用双引号
  - `tabWidth: 2`：2空格缩进
  - `printWidth: 100`：最大行宽100
  - `trailingComma: "es5"`：ES5兼容的尾随逗号

- **运行命令**：
  - `pnpm format`：格式化所有文件

### 3. TypeScript

- **配置文件**：`tsconfig.json`
- **主要配置**：
  - `strict: true`：启用严格模式
  - `noEmit: true`：不生成输出文件
  - `skipLibCheck: true`：跳过库文件检查
  - `isolatedModules: true`：每个文件作为单独的模块

- **运行命令**：
  - `pnpm type-check`：运行TypeScript类型检查

### 4. 依赖检查

- **工具**：`npm-check`
- **检查内容**：
  - 未使用的依赖
  - 缺失的依赖
  - 可更新的依赖

- **运行命令**：
  - `pnpm check:deps`：运行依赖检查

### 5. 代码质量报告

- **工具**：自定义脚本`scripts/generate-report.js`
- **报告类型**：
  - ESLint报告
  - 代码复杂度报告
  - 依赖分析报告

- **运行命令**：
  - `pnpm report`：生成所有报告
  - `pnpm report:eslint`：仅生成ESLint报告
  - `pnpm report:complexity`：仅生成代码复杂度报告
  - `pnpm report:deps`：仅生成依赖分析报告

### 6. Git钩子

- **工具**：Husky和lint-staged
- **钩子类型**：
  - `pre-commit`：提交前运行lint-staged，检查和格式化暂存的文件
  - `pre-push`：推送前运行全面代码质量检查

## API调用规范

### 1. 基本规则

- **统一入口**：所有API调用应通过`apiService`进行，避免直接使用fetch或axios
- **路径格式**：API路径应以斜杠开头，不以斜杠结尾（除非包含查询参数）
- **基础URL**：使用环境变量`NEXT_PUBLIC_API_BASE_URL`作为API基础URL
- **API前缀**：所有API路径应使用`/api/v1/`前缀

### 2. 认证方式

- **Bearer认证**：需要认证的API应使用Bearer认证
- **Token存储**：认证令牌应存储在localStorage中的`access_token`键下
- **Token获取**：使用`getAuthToken()`函数获取认证令牌

### 3. 错误处理

- **统一格式**：所有API响应应转换为统一的`ApiResponse<T>`格式
- **错误检查**：检查`response.error`或HTTP状态码判断是否有错误
- **用户反馈**：API错误应通过`alertService`或其他方式向用户提供反馈

### 4. 响应类型

- **类型定义**：为API响应定义明确的类型，避免使用`any`
- **类型位置**：API相关类型应在`types/api.ts`中定义
- **通用接口**：使用`ApiResponse<T>`作为所有API响应的通用接口

## 组件开发规范

### 1. 组件结构

- **职责单一**：每个组件应只负责一个功能
- **逻辑分离**：将业务逻辑与UI渲染分离
- **状态管理**：使用自定义钩子管理复杂状态
- **组件大小**：控制组件大小，过大的组件应拆分

### 2. Props设计

- **类型定义**：为组件props定义明确的接口
- **默认值**：为可选props提供合理的默认值
- **属性排序**：按照ESLint规则排序props（保留字段优先，回调函数最后）
- **属性验证**：使用TypeScript进行props类型验证

### 3. 性能优化

- **记忆化**：使用`useMemo`和`useCallback`避免不必要的重新计算和渲染
- **依赖数组**：正确设置React Hooks的依赖数组
- **条件渲染**：避免在条件语句中使用Hooks
- **列表渲染**：为列表项提供稳定的`key`

### 4. 可访问性

- **语义化标签**：使用语义化HTML标签
- **ARIA属性**：为非标准控件添加适当的ARIA属性
- **键盘导航**：确保组件可通过键盘导航
- **颜色对比度**：确保文本与背景有足够的对比度

## 性能优化指南

### 1. 渲染优化

- **避免不必要的渲染**：使用`React.memo`、`useMemo`和`useCallback`
- **虚拟列表**：对长列表使用虚拟化技术
- **懒加载**：使用`React.lazy`和`Suspense`懒加载组件
- **代码分割**：使用动态导入进行代码分割

### 2. 数据获取

- **缓存**：对频繁请求的数据进行缓存
- **预取**：在用户可能需要数据前预先获取
- **分页**：对大量数据使用分页加载
- **防抖和节流**：对用户输入相关的请求使用防抖和节流

### 3. 资源优化

- **图片优化**：使用Next.js的`Image`组件优化图片
- **字体优化**：使用`next/font`优化字体加载
- **CSS优化**：使用Tailwind CSS减少CSS体积
- **Tree Shaking**：确保未使用的代码被移除

## 常见问题与解决方案

### 1. ESLint警告

#### 认知复杂度过高
- **解决方案**：将复杂函数拆分为多个小函数，提取重复逻辑，简化条件判断

#### React Hooks依赖警告
- **解决方案**：确保依赖数组包含所有必要的依赖，或使用`useCallback`和`useMemo`

#### 未使用变量
- **解决方案**：移除未使用的变量，或使用下划线前缀（`_variable`）标记有意忽略的变量

### 2. TypeScript错误

#### 类型不兼容
- **解决方案**：定义明确的接口，使用类型断言，或修改代码以符合类型要求

#### 对象可能为undefined
- **解决方案**：使用可选链（`?.`）和空值合并（`??`）操作符

### 3. 构建错误

#### 图片优化问题
- **解决方案**：使用Next.js的`Image`组件，或在`next.config.js`中配置`images.domains`

#### 依赖问题
- **解决方案**：安装缺失的依赖，更新过时的依赖，或修复依赖冲突

## 提交前检查清单

在提交代码前，请确保：

1. **代码格式化**：运行`pnpm format`格式化代码
2. **ESLint检查**：运行`pnpm lint`修复ESLint警告
3. **TypeScript检查**：运行`pnpm type-check`确保无类型错误
4. **依赖检查**：运行`pnpm check:deps`检查依赖问题
5. **全面检查**：运行`pnpm check`执行全面代码质量检查
6. **手动测试**：确保功能正常工作，无明显bug
7. **代码审查**：如果可能，请同事审查你的代码

---

本文档将随项目发展不断更新。如有疑问或建议，请联系项目维护者。
